// ================================================================
// ðŸŽ® PermGuard - Minecraft Plugin
// ================================================================
// ðŸ“– Repository: https://github.com/alex2276564/PermGuard
// ðŸ”§ Build tool: Gradle
// â˜• Java version: 17
// ðŸŽ¯ Target: Paper/Folia 1.16.5+
// ================================================================

// ================================================================
// ðŸ”Œ PLUGINS
// ================================================================
// Core build plugins and tooling
// ================================================================

plugins {
    id 'java'
    id 'com.gradleup.shadow' version '9.3.1'           // Shadow JAR (shading dependencies)
    id 'xyz.jpenilla.run-paper' version '3.0.2'       // Paper test server runner
}

// ================================================================
// ðŸ“¦ PROJECT INFORMATION
// ================================================================

group = 'uz.alex2276564'
version = '1.0.4'

// ================================================================
// â˜• JAVA CONFIGURATION
// ================================================================

def targetJavaVersion = 17

java {
    def javaVersion = JavaVersion.toVersion(targetJavaVersion)
    sourceCompatibility = javaVersion
    targetCompatibility = javaVersion

    // Use toolchain if current Java version is older than target
    if (JavaVersion.current() < javaVersion) {
        toolchain.languageVersion = JavaLanguageVersion.of(targetJavaVersion)
    }
}

// ================================================================
// ðŸ“š REPOSITORIES
// ================================================================
// Maven repositories for dependency resolution
// ================================================================

repositories {
    // ----------------------------------------------------------------
    // ðŸŒ Public repositories
    // ----------------------------------------------------------------
    mavenCentral()

    // ----------------------------------------------------------------
    // ðŸ“¦ Minecraft/Paper repositories
    // ----------------------------------------------------------------
    maven {
        name = 'papermc-repo'
        url = 'https://repo.papermc.io/repository/maven-public/'
    }

    maven {
        name = 'sonatype'
        url = 'https://oss.sonatype.org/content/groups/public/'
    }

    // ----------------------------------------------------------------
    // ðŸ”Œ Plugin repositories
    // ----------------------------------------------------------------
    maven {
        name = 'okaeri'
        url = 'https://repo.okaeri.cloud/releases'
    }

    maven {
        name = 'tcoded-releases'
        url = 'https://repo.tcoded.com/releases'
    }
}

// ================================================================
// ðŸ“¦ DEPENDENCIES
// ================================================================
// Project dependencies organized by category
// ================================================================

dependencies {
    // ----------------------------------------------------------------
    // ðŸŽ® Minecraft API (compileOnly - provided by server)
    // ----------------------------------------------------------------
    compileOnly 'com.destroystokyo.paper:paper-api:1.16.5-R0.1-SNAPSHOT'

    // ----------------------------------------------------------------
    // ðŸ”Œ Plugin APIs (compileOnly - optional soft dependencies)
    // ----------------------------------------------------------------
    compileOnly 'net.kyori:adventure-text-minimessage:4.26.1'

    // ----------------------------------------------------------------
    // ðŸ› ï¸ Development tools (compileOnly + annotationProcessor)
    // ----------------------------------------------------------------
    compileOnly 'org.projectlombok:lombok:1.18.42'
    annotationProcessor 'org.projectlombok:lombok:1.18.42'

    testCompileOnly 'org.projectlombok:lombok:1.18.42'
    testAnnotationProcessor 'org.projectlombok:lombok:1.18.42'

    // ----------------------------------------------------------------
    // ðŸ“š Libraries (implementation - will be shaded into final JAR)
    // ----------------------------------------------------------------
    // Configuration library
    implementation 'eu.okaeri:okaeri-configs-yaml-snakeyaml:5.0.13'

    // JSON serialization (required for legacy 1.16.x compatibility)
    implementation 'com.google.code.gson:gson:2.13.2'

    // Folia compatibility layer
    implementation 'com.tcoded:FoliaLib:0.5.1'
}

// ================================================================
// ðŸ”’ DEPENDENCY LOCKING
// ================================================================
// Ensures reproducible builds and better security scanning
//
// ðŸ“ How to use:
// â€¢ When adding/updating dependencies, run:
//   ./gradlew dependencies --write-locks
// â€¢ Commit both build.gradle and gradle.lockfile
// â€¢ Renovate will automatically update lockfile in PRs
//
// ðŸ” Benefits:
// â€¢ Reproducible builds across environments
// â€¢ Security scanners (OSV, Trivy) see ALL dependencies
// â€¢ Protection against dependency confusion attacks
// ================================================================

dependencyLocking {
    lockAllConfigurations()
}

// ================================================================
// ðŸ“¦ SHADOW JAR (SHADING)
// ================================================================
// âš ï¸ IMPORTANT: Shading is REQUIRED for legacy compatibility!
// 
// Why shading is necessary:
// â€¢ Old server versions (1.16.x and below) don't provide modern libraries
// â€¢ Libraries like Gson may be outdated or missing on legacy servers
// â€¢ Shading ensures all dependencies are bundled and isolated
// â€¢ Prevents conflicts with other plugins using different versions
// 
// Relocation strategy:
// â€¢ All shaded libraries moved to uz.alex2276564.permguard.libs.*
// â€¢ This prevents classpath conflicts with other plugins
// ================================================================

shadowJar {
    // Don't append '-all' suffix to JAR filename
    archiveClassifier.set('')

    // Merge service files (required for some libraries)
    mergeServiceFiles()

    // ----------------------------------------------------------------
    // ðŸ“¦ Library relocations (prevent conflicts)
    // ----------------------------------------------------------------
    relocate 'eu.okaeri.configs', 'uz.alex2276564.permguard.libs.okaeri.configs'
    relocate 'org.yaml.snakeyaml', 'uz.alex2276564.permguard.libs.snakeyaml'
    relocate 'com.google.gson', 'uz.alex2276564.permguard.libs.gson'
    relocate 'com.tcoded.folialib', 'uz.alex2276564.permguard.libs.folialib'
}

// ================================================================
// ðŸ—ï¸ BUILD CONFIGURATION
// ================================================================

// Always build shadowJar instead of regular JAR
build {
    dependsOn shadowJar
}

// ================================================================
// âš™ï¸ TASKS
// ================================================================

// ----------------------------------------------------------------
// ðŸŽ® Development server (run-paper plugin)
// ----------------------------------------------------------------
tasks {
    runServer {
        // Minecraft version for local testing
        // Plugin JAR (shadowJar) will be automatically loaded
        minecraftVersion('1.16.5')
    }
}

// ----------------------------------------------------------------
// â˜• Java compilation
// ----------------------------------------------------------------
tasks.withType(JavaCompile).configureEach {
    // Use UTF-8 encoding for source files
    options.encoding = 'UTF-8'

    // Use --release flag if Java 10+ (better compatibility)
    if (targetJavaVersion >= 10 || JavaVersion.current().isJava10Compatible()) {
        options.release.set(targetJavaVersion)
    }
}

// ----------------------------------------------------------------
// ðŸ“„ Resource processing (plugin.yml, config.yml, etc.)
// ----------------------------------------------------------------
processResources {
    // Expand ${version} placeholder in plugin.yml
    def props = [version: version]
    inputs.properties props

    filteringCharset = 'UTF-8'

    filesMatching('plugin.yml') {
        expand props
    }
}